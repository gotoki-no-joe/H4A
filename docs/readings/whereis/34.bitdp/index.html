<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="turbo-root" content="/H4A">
    <meta name="turbo-cache-control" content="no-cache">

    <!-- Primary Meta Tags -->
    <title>34.集合のビット表現 (was: BitDP)</title>
    <meta name="title" content="34.集合のビット表現 (was: BitDP)">
    <meta name="description" content="BitDPについて" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gotoki-no-joe.github.io/H4A/readings/whereis/34.bitdp/">
    <meta property="og:title" content="34.集合のビット表現 (was: BitDP)">
    <meta property="og:description" content="BitDPについて">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://gotoki-no-joe.github.io/H4A/readings/whereis/34.bitdp/">
    <meta property="twitter:title" content="34.集合のビット表現 (was: BitDP)">
    <meta property="twitter:description" content="BitDPについて">
    
    <script>(function () { var el = document.documentElement, m = localStorage.getItem("/H4A/doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="/H4A/resources/css/retype.css?v=1.10.699789449996" rel="stylesheet" data-turbo-track="reload" />

    <script type="text/javascript" src="/H4A/resources/js/config.js?v=1.10.699789449996" defer data-turbo-track="reload"></script>
    <script type="text/javascript" src="/H4A/resources/js/retype.js?v=1.10" defer data-turbo-track="reload"></script>
    <script id="prism-js" type="text/javascript" src="/H4A/resources/js/prism.js?v=1.10.699789449996" defer></script>
    <link href="/H4A/resources/css/katex.css?v=1.10" rel="stylesheet" />
    <script id="katex-js" type="text/javascript" src="/H4A/resources/js/katex.js?v=1.10" defer></script>
</head>
    <body>
        <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
    <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>

    <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
    <div class="container relative flex items-center justify-between flex-grow pr-6 md:justify-start">
        <!-- Mobile menu button skeleton -->
        <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center flex-shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
        <div v-cloak id="docs-sidebar-toggle"></div>

        <!-- Logo -->
        <div class="flex items-center justify-between h-full py-2 md:w-75">
            <div class="flex items-center px-2 md:px-6">
                <a id="docs-site-logo" href="/H4A/" class="flex items-center leading-snug text-xl">
                    <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">Haskell for AtCoder</span>
                </a><span class="hidden px-2 py-1 ml-4 text-sm font-semibold leading-none text-root-logo-label-text bg-root-logo-label-bg rounded-sm md:inline-block">(引っ越し作業中)</span>
            </div>

            <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
        </div>

        <div class="flex justify-between md:flex-grow">
            <!-- Top Nav -->
            <nav class="hidden md:flex">
    <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
    </ul>
</nav>

            <!-- Header Right Skeleton -->
            <div v-cloak class="flex justify-end flex-grow skeleton">

                <!-- Search input mock -->
                <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                    <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                    </div>

                    <input class="w-full h-10 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 placeholder-gray-400 dark:placeholder-dark-400"
                    style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search docs" />
                </div>

                <!-- Mobile search button mock -->
                <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                </div>

                <!-- Dark mode switch placehokder -->
                <div class="w-10 h-10 lg:ml-2"></div>

                <!-- History button mock -->
                <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                </div>
            </div>

            <div v-cloak class="flex items-center justify-end flex-grow">
                <div id="docs-mobile-search-button"></div>
                <doc-search-desktop></doc-search-desktop>

                <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                <doc-history></doc-history>
            </div>
        </div>
    </div>
</header>


    <div class="container relative flex bg-white">
        <!-- Sidebar Skeleton -->
<div v-cloak class="fixed flex flex-col flex-shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">

    <!-- Render this div, if config.showSidebarFilter is `true` -->
    <div class="flex items-center h-16 px-6">
        <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter" />
    </div>

    <div class="pl-6 mb-4 mt-1">
        <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
    </div>

    <div class="flex-shrink-0 mt-auto bg-transparent dark:border-dark-650">
        <a
    class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in"
    target="_blank"
    href="https://retype.com/"
    rel="noopener"
>
    <span class="text-xs whitespace-nowrap">Powered by</span>
    <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
</a>

    </div>
</div>

<!-- Sidebar component -->
<doc-sidebar v-cloak>
    <template #sidebar-footer>
        <div
            class="flex-shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650"
        >

            <a
    class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in"
    target="_blank"
    href="https://retype.com/"
    rel="noopener"
>
    <span class="text-xs whitespace-nowrap">Powered by</span>
    <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
</a>

        </div>
    </template>
</doc-sidebar>


        <div class="flex-grow min-w-0 dark:bg-dark-850">
            <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
            <div class="flex">
    <div class="flex-grow min-w-0 px-6 md:px-16">
        <main class="relative pt-6 pb-16">
            <div class="docs-markdown" id="docs-content">
                <!-- Rendered if sidebar right is enabled -->
                <div id="docs-sidebar-right-toggle"></div>
               
                <!-- Page content  -->
<doc-anchor-target id="34集合のビット表現-was-bitdp" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#34集合のビット表現-was-bitdp">#</doc-anchor-trigger>
        <span>34.集合のビット表現 (was: BitDP)</span>
    </h1>
</doc-anchor-target>
<p><a href="https://qiita.com/masayoshi361/items/0be4bce77783b6013b34">BitDPについて</a></p>
<doc-anchor-target id="原理集合のビット表現による数え上げ">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#原理集合のビット表現による数え上げ">#</doc-anchor-trigger>
        <span>原理：集合のビット表現による数え上げ</span>
    </h2>
</doc-anchor-target>
<p>要素数が20個くらいまでの集合に関して、その全ての部分集合について考える必要があるとき、
要素の数え上げ順を用いて部分集合を数え上げ、自然数に対応させるテクニック。</p>
<p>要素数 <span class="math">N</span> の集合の各要素に番号をつけて <span class="math">U = \{a_0, a_1, a_{N-1}\}</span> と呼ぶ。
このとき、任意の部分集合 <span class="math">S</span> にもまた番号 <span class="math">n(S)</span> を割り当てることができる。
この番号は、 <span class="math">S</span> に要素 <span class="math">a_i</span> が含まれるとき <span class="math">n(S)</span> のビット <span class="math">i</span> を <span class="math">1</span> とし、
含まれないとき <span class="math">0</span> とする。すると <span class="math">0 \leq k &lt; 2^N</span> で、
空集合は <span class="math">n(\empty) = 0</span>、全体集合は <span class="math">n(U) = 2^N-1</span> 番になる。</p>
<p>この番号付けの重要な性質は、ある集合の真部分集合に割り当てられる番号は必ず、
より小さい値になることである。</p>
<ul>
<li><span class="math">S \supset S' \Rightarrow n(S) &gt; n(S')</span></li>
</ul>
<p>（ただし逆はいえない。集合の包含関係は半順序であるから。）</p>
<p>これにより、ある全体集合の全ての部分集合について、何かの値を記録するとき、
整数添え字の配列にそれらを格納することができ、
またその値が、より小さな部分集合の値を参照して求められるとき、
その値は配列のより小さい添え字の位置にあることが保障されるため、
添え字の小さい方から計算していくことができる。（ほとんどネタバレ）</p>
<doc-anchor-target id="動的プログラミングへの応用">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#動的プログラミングへの応用">#</doc-anchor-trigger>
        <span>動的プログラミングへの応用</span>
    </h2>
</doc-anchor-target>
<!-- 以降、簡単のため、対象を $0$ から $N-1$ までの整数とする。-->
<doc-anchor-target id="例題abc199e">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#例題abc199e">#</doc-anchor-trigger>
        <span>例題：ABC199E</span>
    </h3>
</doc-anchor-target>
<p><a href="https://atcoder.jp/contests/abc199/tasks/abc199_e">ABC199 E Permutation</a></p>
<doc-anchor-target id="抽象的な攻略">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#抽象的な攻略">#</doc-anchor-trigger>
        <span>抽象的な攻略</span>
    </h4>
</doc-anchor-target>
<p><span class="math">U = \{1,\dots,N\}</span> の全ての部分集合 <span class="math">S</span> に対して、
「その要素の順列であって、条件を満たすものの個数 <span class="math">c(S)</span> 」を
求めることを考える。すると
<span class="math">c(\empty) = 1</span> であり、 <span class="math">c(U)</span> が求める値である。</p>
<p>ある集合 <span class="math">S</span> について <span class="math">c(S)</span> を求めることを考える。
すると、そこからいずれかの要素 <span class="math">x \in S</span> を除いた
部分集合 <span class="math">S \backslash \{x\}</span> で可能な順列の末尾に <span class="math">x</span> を
続けたものすべてを数えればよいので、</p>
<div class="math"><pre>c(S) = \sum_{x \in S} c(S \backslash \{x\})</pre></div>
<p>となるはずである。ただし、これらは条件を満たすものである必要がある。
そのため、 <span class="math">|S| = X_i</span> であるような制約 <span class="math">(X_i,Y_i,Z_i)</span> を満たすことを確認する。
これは <span class="math">|\{a \in S \, | \, a \leq Y_i\}| \leq Z_i</span> である。</p>
<p>ここで、 <span class="math">|S| &gt; X_i</span> であるような制約についても、それらを満たさないものを除外する必要が
あるように思われるが、それらについては <span class="math">|S'| = X_i</span> である <span class="math">c(S')</span> を求める際に考慮が済んでいるので
その必要はない。以上をまとめると次の漸化式を得る。</p>
<div class="math"><pre>c(S) = \left \{
\begin{array}{ll}
1 &amp; S=\empty のとき \\
\sum_{x \in S} c(S \backslash \{x\}) &amp; \forall (X_i,Y_i,Z_i) \; |S| = X_i \Rightarrow |\{a \in S \, | \, a \leq Y_i\} | \leq Z_i のとき \\
0 &amp; それ以外のとき
\end{array} \right .</pre></div>
<p>この漸化式を直接再帰的に計算して <span class="math">c(U)</span> を求めると同じ部分集合に関する計算が重複しまくるので、
メモ化により計算量を節約する。</p>
<p>Haskellでは配列 <code v-pre>Data.Array</code> だけでなく写像 <code v-pre>Data.Map</code> を用いてメモ化による動的プログラミングが実現でき、
また写像のキーに整数集合 <code v-pre>IntSet</code> が使えるので、上の式をほぼそのまま翻訳できる。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">import Data.Array
import Data.Maybe
import qualified Data.Map as M
import qualified Data.IntSet as IS

abc199e :: Int -&gt; Int -&gt; [[Int]] -&gt; Int
abc199e n _m xyzs = c M.! IS.fromList [1..n]
  where
    conds = accumArray (flip (:)) [] (1,n) [(x,(y,z)) | (x:y:z:_) &lt;- xyzs]
    c :: M.Map IS.IntSet Int
    c = M.fromList $
        map (f . IS.fromList . catMaybes) $
        sequence [[Nothing, Just i] | i &lt;- [1..n]]
    f s
      | IS.null s = (s, 1)
      | isOK      = (s, sum [c M.! IS.delete x s | x &lt;- IS.elems s])
      | otherwise = (s, 0)
      where
        isOK = and [z &gt;= IS.size (fst $ IS.split (succ y) s) | (y,z) &lt;- conds ! IS.size s]</code></pre>
</doc-codeblock></div>
<p>この実装は数学的表現とよく対応して美しいが、<a href="https://atcoder.jp/contests/abc199/submissions/29782691">計算時間的には無理がある</a>。</p>
<doc-anchor-target id="集合のビット表現による効率化">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#集合のビット表現による効率化">#</doc-anchor-trigger>
        <span>集合のビット表現による効率化</span>
    </h4>
</doc-anchor-target>
<p>そこで、直接 <code v-pre>IntSet</code> をキーにした <code v-pre>Map</code> を作る代わりに、
ビット表現をキーにした整数添え字配列で実現する。
<span class="math">\{1,\dots,Y\}</span> の表現が <span class="math">2^Y - 1</span> になるように、1ずらして考えている。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">import Data.Array
import Data.Bits

abc199e :: Int -&gt; Int -&gt; [[Int]] -&gt; Int
abc199e n m xyzs = c ! pow2n1
  where
    pow2n1 = pred $ shiftL 1 n
    conds = accumArray (flip (:)) [] (1,n) [(x,(y,z)) | (x:y:z:_) &lt;- xyzs]
    c :: Array Int Int
    c = listArray (0,pow2n1) $ map f [0..pow2n1]
    f 0        = 1
    f s | isOK = sum [c ! clearBit s x1 | x1 &lt;- [0..pred n], testBit s x1]
        | True = 0
      where
        isOK = and [z &gt;= popCount (s .&amp;. pred (shiftL 1 y)) | (y,z) &lt;- conds ! popCount s]</code></pre>
</doc-codeblock></div>
<p>要素が含まれるかどうかは <code v-pre>testBit</code> で判定できる、
1要素を取り除いた集合の表現は <code v-pre>clearBit</code> で作れる、
共通部分はビットごとの論理積で求められる、
集合の要素数が <code v-pre>popCount</code> で数えられる、
という対応関係が興味深い。
<a href="https://atcoder.jp/contests/abc199/submissions/29771345">このコードはACする。</a></p>
<doc-anchor-target id="パターン化">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#パターン化">#</doc-anchor-trigger>
        <span>パターン化</span>
    </h3>
</doc-anchor-target>
<p>上のABC199Eに似て、
<a href="https://atcoder.jp/contests/abc041/tasks/abc041_d">ABC041 D 徒競走</a>もまた、
順列の中で、指定した条件を満たすものの個数を数える問題である。
ABC199Eでは、今考えている集合 <span class="math">S</span> が条件を満たすものか否か、だけを考えたが、
ABC041Dでは、一つ小さい集合 <span class="math">S \backslash \{x\}</span> の順列の末尾に <span class="math">x</span> を追加したとき、
条件に反しないかどうか、を個別に判定して集めてくる形になる。</p>
<p>部分集合 <span class="math">S</span> の順列で条件を満たすものの個数を <span class="math">c(S)</span> 、
<span class="math">S</span> から要素 <span class="math">x</span> を減らした集合に対する <span class="math">c</span> について、それらの順列の末尾に <span class="math">x</span> を追加した順列を
どれだけ数えるかを決める関数を <span class="math">g</span> とすると、
漸化式は以下のようになる。（cはcountのc）</p>
<div class="math"><pre>c(S) = \left \{
\begin{array}{ll}
1 &amp; S = \empty のとき \\
\sum_{x \in S} g(c(S \, \backslash \, \{x\}), S \, \backslash \, \{x\}, x) &amp; それ以外のとき
\end{array}
\right .</pre></div>
<p>ABC041Dでは、条件で <span class="math">x</span> よりも後に来るべきと指定されている要素が <span class="math">S \backslash \{x\}</span> に含まれるとき
<span class="math">g = 0</span>, さもなくば <span class="math">g = c(S \backslash \{x\})</span> とすればよい。</p>
<p>例題がないが、順列に関するコストを最小化する問題も同様に対応できる。
<span class="math">g</span> も上と同様な情報から最小コストを算出する関数として、
漸化式は以下のようになる。（cはcostのc）</p>
<div class="math"><pre>c(S) = \left \{
\begin{array}{ll}
\infty &amp; S = \empty のとき \\
\min_{x \in S} \, g(c(S \, \backslash \, \{x\}), S \, \backslash \, \{x\}, x) &amp; それ以外のとき
\end{array}
\right .</pre></div>
<p>となる。</p>
<p>この二つの漸化式は、
空集合に対する値（ <span class="math">1</span> か <span class="math">\infty</span> か）、
要素をひとつ減らした集合に対する結果 <span class="math">g</span> を集める方法（ <span class="math">\sum</span> か <span class="math">\min</span> か）だけが異なるので、
これらをパラメータとして統合できる。
ABC199Eの場合も含めてこれらを一般化すると、次のHaskellプログラムを得る。
引数 <code v-pre>base</code> が空集合に対する値、
<code v-pre>accum</code> が <span class="math">g</span> を集める方法、
<code v-pre>g</code> が <span class="math">g</span> に対応する。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">import Data.Bits

type BitSet = Int

bitDP :: a -&gt; (BitSet -&gt; [a] -&gt; a) -&gt; (a -&gt; BitSet -&gt; Int -&gt; a) -&gt; Int -&gt; a
bitDP base accum g n = arr ! all1
  where
    all1 = 2^n - 1
    arr = listArray (0,all1) $ map f [0..all1]
    f 0 = base
    f k = accum k [g (arr ! k1) k1 i | i &lt;- [0..pred n], testBit k i, let k1 = clearBit k i]</code></pre>
</doc-codeblock></div>
<p>さらにMutable Vectorに直す。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">import Data.Bits
import qualified Data.Vector.Unboxed.Mutable as MUV
import Control.Monad
import Control.Monad.ST

type BitSet = Int

bitDP :: a -&gt; (BitSet -&gt; [a] -&gt; a) -&gt; (a -&gt; BitSet -&gt; Int -&gt; a) -&gt; Int -&gt; a
bitDP base accum g n = runST action
  where
    pow2n = 2^n
    pow2n1 = pred pow2n
    action :: ST s Int
    action = do
      v &lt;- MUV.new pow2n
      MUV.write v 0 base
      forM_ [1..pow2n1] $ (\k -&gt; do
        gs &lt;- forM [i | i &lt;- [0..pred n], testBit k i] $ (\i -&gt; do
            let k1 = clearBit k i
            fk1 &lt;- MUV.read v k1
            return $ g fk1 k1 i
            )
        MUV.write v k $ accum k gs
        )
      MUV.read v pow2n1</code></pre>
</doc-codeblock></div>
<p>このような、順列に関する問題に対する計算コストは、
素朴に生成と評価を行うと <span class="math">O(N!)</span> であるところ、
<span class="math">2^N</span> 要素の配列の内容を順に求めていく形に変形され、
<span class="math">g</span> の計算を <span class="math">O(1)</span> と仮定すると <span class="math">O(2^N)</span> となる。</p>
<p>どちらもずいぶん大きな値に見えるが、階乗の方が大きい。</p>
<div class="math"><pre>\begin{array}{llll}
N! &amp; = 1 \times 2 \times 3 \times \dots \times (N-1) &amp; \times &amp; N \\
2^N &amp; = 2 \times 2 \times 2 \times \dots \times 2    &amp; \times &amp; 2
\end{array}</pre></div>
<doc-anchor-target id="巡回セールスマン問題">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#巡回セールスマン問題">#</doc-anchor-trigger>
        <span>巡回セールスマン問題</span>
    </h3>
</doc-anchor-target>
<p>巡回セールスマン問題を解くには、
都市の部分集合について、それらを巡回する経路でコストの最も安いものをそれぞれ求める。
つまり順列のコスト最小化をする。</p>
<p>ただし、ある都市集合 <span class="math">S</span> のコストを求める漸化式が上のパターンに当てはまらない。
都市を一つ <span class="math">x</span> 除いた集合のコスト <span class="math">c(S \backslash \{x\})</span> と追加する都市 <span class="math">x</span> からだけでは <span class="math">c(S)</span> が求められない。  <br />
コスト関数の引数を、都市集合に加えて、順列の末尾がどこかも指定する。
つまり、 <span class="math">c(S,y)</span> を都市集合 <span class="math">S</span> を巡回して都市 <span class="math">y</span> で終わる経路の最も安いコストとする。  <br />
すると、都市間のコストを <span class="math">\textrm{cost}</span> で表すとして、積み上げは次のようにできる。
（ <span class="math">x \in S</span> とする）</p>
<div class="math"><pre>c(S,x) = \min_{y \in S \backslash \{x\}} \big ( c(S \backslash \{x\}, y) + \textrm{cost}(y,x) \big )</pre></div>
<p>漸化式は以下のようにまとめられる。
（出発点の制約など、問題によって一部変化するので、一つの例として）</p>
<div class="math"><pre>c(S,x) = \left \{
\begin{array}{ll}
0 &amp; S = \{x\} のとき \\
\infty &amp; x \not\in S のとき \\
\min_y \big ( c(S \backslash \{x\}, y) + \textrm{cost}(y,x) \big ) &amp; それ以外のとき
\end{array}
\right .</pre></div>
<p>この2引数関数 <span class="math">c(S,x)</span> を二次元配列にメモ化すればよい。</p>
<doc-anchor-target id="発展">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#発展">#</doc-anchor-trigger>
        <span>発展</span>
    </h4>
</doc-anchor-target>
<p>上の <span class="math">c(S,x)</span> は結局、 <span class="math">x \in S</span> の範囲をまとめて調べる使い方しかされない。
そこで、この関数をカリー化する、あるいは <span class="math">S</span> に対して、
末尾の都市からコストへの写像（または一次元配列）を対応づける一次元配列とみなす。</p>
<p>そうすると、上の <code v-pre>bitDP</code> のインスタンスにできそうにも見える。</p>
<doc-anchor-target id="順列でない例">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#順列でない例">#</doc-anchor-trigger>
        <span>順列でない例</span>
    </h3>
</doc-anchor-target>
<p><a href="https://atcoder.jp/contests/abc142/tasks/abc142_e">ABC142 E Get Everything</a> は、
全ての宝箱の組み合わせに関して、それらを全て開ける鍵の費用の最安値を状態とする。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">State :: Array BitSet Int</code></pre>
</doc-codeblock></div>
<p>最初、鍵をひとつも選んでいないとき、どの箱も開けられないことを、不可能を表す大きな値で表す。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">initialState :: State
initialState = listArray (0,2^n-1) $ 0 : replicate (2^n-1) (div maxBound 2)</code></pre>
</doc-codeblock></div>
<p>一つの鍵を手に取ったとき、それも使うことで、より安く開けられる宝箱のパターンを全て更新する。  <br />
パターン <code v-pre>s</code> を開ける既知の最小コストが <code v-pre>x</code> であり、
鍵がコスト <code v-pre>a</code> でパターン <code v-pre>cs</code> を開けられるとき、
パターン <code v-pre>s .|. cs</code> をコスト <code v-pre>x + a</code> で開けられる。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">step :: State -&gt; (Int, BitSet) -&gt; State
step st (a, cs) = accum min st [(s .|. cs, x + a) | (s,x) &lt;- assocs st]</code></pre>
</doc-codeblock></div>
<p>全ての鍵を試したあと、全て開けられるバターンの最安値が答えである。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-haskell"><code v-pre class="language-haskell">answer = foldl step initialState acss ! (2^n-1)</code></pre>
</doc-codeblock></div>
<p>この例は、集合のビット表現を用いているし、動的プログラミングも用いているが、
動的プログラミングの進行方向と集合のビット表現は無関係で、順列も関係しない。
私見だが「bitDP」という言葉の範囲からは少し外れた例に見える。</p>
<doc-anchor-target id="関連問題">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#関連問題">#</doc-anchor-trigger>
        <span>関連問題</span>
    </h2>
</doc-anchor-target>
<ul>
<li><a href="https://atcoder.jp/contests/abc180/tasks/abc180_e">ABC180 E Traveling Salesman among Aerial Cities</a> - <a href="https://atcoder.jp/contests/abc180/submissions/29618221">ACコード</a>  <br />
Vector化したが、Unboxできなかったせいか<a href="https://atcoder.jp/contests/abc180/submissions/29621326">遅くなった</a></li>
<li><a href="https://atcoder.jp/contests/abc142/tasks/abc142_e">ABC142 E Get Everything</a> - <a href="https://atcoder.jp/contests/abc142/submissions/29616204">ACコード</a></li>
<li><a href="https://atcoder.jp/contests/abc199/tasks/abc199_e">ABC199 E Permutation</a> - <a href="https://atcoder.jp/contests/abc199/submissions/29771345">ACコード</a></li>
<li><a href="https://abc041.contest.atcoder.jp/tasks/abc041_d">ABC041 D 徒競走</a> - <a href="https://atcoder.jp/contests/abc041/submissions/29606819">ACコード</a></li>
<li><a href="https://atcoder.jp/contests/dwacon2018-prelims/tasks/dwacon2018_prelims_d">第4回 ドワンゴからの挑戦状 予選 D ディスクの節約</a></li>
</ul>




                <!-- Required only on API pages -->
                <doc-toolbar-member-filter-no-results />
            </div>

            
<nav class="flex mt-14">
    <div class="w-1/2">
        <a class="px-5 py-4 h-full flex items-center break-all md:break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="/H4A/readings/whereis/33.lcs/">
            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
            <span>
                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                <span class="block mt-1">33.最長共通部分列</span>
            </span>
        </a>
    </div>

    <div class="w-1/2">
        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-all md:break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="/H4A/readings/whereis/35.binary-octal-hexadecimal-notation/">
            <span>
                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                <span class="block mt-1">35.(2|8|16)進数表記</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
        </a>
    </div>
</nav>


        </main>

        <div class="border-t dark:border-dark-650 pt-6 mb-8">
            <footer class="flex flex-wrap items-center justify-between">
    <div>
        <ul class="flex flex-wrap items-center text-sm">
</ul>

    </div>
    <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2022. All rights reserved.</p>
</div>
</footer>

        </div>
    </div>
    
    <!-- Rendered if sidebar right is enabled -->
    <!-- Sidebar right skeleton-->
    <div v-cloak class="fixed top-0 bottom-0 right-0 transform translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:flex-shrink-0 lg:pt-6 lg:transform-none lg:w-56 lg:z-0 md:w-72 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
        <div class="pl-5">
            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
        </div>
    </div>
    
    <!-- User should be able to hide sidebar right -->
    <doc-sidebar-right v-cloak></doc-sidebar-right>
</div>

        </div>
    </div>

    <doc-search-mobile></doc-search-mobile>
    <doc-back-to-top></doc-back-to-top>
</div>


        <div id="docs-overlay-target"></div>

        <script>window.__DOCS__ = { "title": "34.集合のビット表現 (was: BitDP)", icon: "file", hasPrism: true, hasMermaid: false, hasMath: true }</script>
    </body>
</html>
